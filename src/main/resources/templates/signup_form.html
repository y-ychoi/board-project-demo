<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì…</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>íšŒì›ê°€ì…</h1>
    
    <form th:action="@{/user/signup}" method="post">
        
        <div th:if="${signupError}" style="color: red; margin-bottom: 15px;">
            <p th:text="${signupError}"></p>
        </div>

        <div>
            <label for="userId">ì•„ì´ë””:</label>
            <input type="text" id="userId" name="userId" required th:value="${prevUserId}">
            <button type="button" id="checkIdBtn">ì¤‘ë³µ í™•ì¸</button> 
            <span id="idCheckResult" style="margin-left: 10px;"></span> 
        </div>

        <div>
            <label for="userPw">ë¹„ë°€ë²ˆí˜¸:</label>
            <input type="password" id="userPw" name="userPw" required>
        </div>
        
        <div>
            <label for="userPw2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label>
            <input type="password" id="userPw2" name="userPw2" required>
        </div>

        <div>
            <label for="name">ì´ë¦„:</label>
            <input type="text" id="name" name="name" required th:value="${prevName}">
        </div>

        <div>
            <label for="email">ì´ë©”ì¼:</label>
            <input type="email" id="email" name="email" required th:value="${prevEmail}">
        </div>

        <button type="submit">ê°€ì…í•˜ê¸°</button>
    </form>

    <a th:href="@{/user/login}">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>

    <script th:inline="javascript">
    $(document).ready(function() {
        
        // ğŸš¨ğŸš¨ğŸš¨ 1. ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ì¶”ê°€ ğŸš¨ğŸš¨ğŸš¨
        // false: ì¤‘ë³µ í™•ì¸ í•„ìš”, true: ì¤‘ë³µ í™•ì¸ ì™„ë£Œ (ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœ)
        var isIdChecked = false; 
        
        // ğŸš¨ 2. ì•„ì´ë”” ì…ë ¥ ë³€ê²½ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
        $("#userId").on('input', function() {
             $("#idCheckResult").text("");
             isIdChecked = false; // ì•„ì´ë””ê°€ ë°”ë€Œë©´ ë¬´ì¡°ê±´ ì¬ê²€ì¦ í•„ìš”
        });

        // ----------------------------------------------------
        // ** ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ê²€ì‚¬ í†µí•©) **
        // ----------------------------------------------------
        $("#checkIdBtn").click(function() {
            var userId = $("#userId").val();
            var resultSpan = $("#idCheckResult");
            
            // ğŸš¨ ì˜ë¬¸/ìˆ«ì 3~15ìë§Œ í—ˆìš©í•˜ëŠ” ì •ê·œ í‘œí˜„ì‹ (JSìš©)
            var regex = /^[a-zA-Z0-9]{3,15}$/; 
            
            // ----------------------------------------------------
            // ğŸš¨ğŸš¨ğŸš¨ 1ì°¨ ê²€ì¦: ê¸¸ì´ ë° í˜•ì‹ ì²´í¬ (AJAX ìš”ì²­ ì „) ğŸš¨ğŸš¨ğŸš¨
            // ----------------------------------------------------
            if (userId === "" || !regex.test(userId)) {
                alert("ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 3~15ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                resultSpan.text("í˜•ì‹ ì˜¤ë¥˜").css('color', 'red');
                isIdChecked = false; // ê²€ì‚¬ ì‹¤íŒ¨í–ˆìœ¼ë¯€ë¡œ ìƒíƒœ ì´ˆê¸°í™”
                return; // ì„œë²„ ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šê³  ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
            }
            
            // ----------------------------------------------------
            // 2ì°¨ ê²€ì¦: ì„œë²„ ì¤‘ë³µ í™•ì¸ (í˜•ì‹ í†µê³¼ ì‹œì—ë§Œ ì‹¤í–‰)
            // ----------------------------------------------------
            $.ajax({
                type: "GET",
                url: "/user/checkId",
                data: { userId: userId },
                success: function(response) {
                    if (response === "true") {
                        // ì¤‘ë³µ (ì‚¬ìš© ë¶ˆê°€ëŠ¥)
                        alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.");
                        resultSpan.text("ì‚¬ìš© ë¶ˆê°€ëŠ¥").css('color', 'red');
                        isIdChecked = false;
                    } else {
                        // ì¤‘ë³µ ì•„ë‹˜ (ì‚¬ìš© ê°€ëŠ¥)
                        alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.");
                        resultSpan.text("ì‚¬ìš© ê°€ëŠ¥!").css('color', 'green');
                        isIdChecked = true;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", error);
                    resultSpan.text("ì„œë²„ í†µì‹  ì˜¤ë¥˜ ë°œìƒ.").css('color', 'red');
                    isIdChecked = false;
                }
            });
        });
        
        // ----------------------------------------------------
        // ** í¼ ì œì¶œ ì´ë²¤íŠ¸ (ê°€ì…í•˜ê¸° ë²„íŠ¼) **
        // ----------------------------------------------------
        $("form").submit(function(event) {
            // ğŸš¨ğŸš¨ğŸš¨ 1ì°¨ ê²€ì¦: ì¤‘ë³µ í™•ì¸ í•„ìˆ˜ ì¡°ê±´ ì²´í¬ ğŸš¨ğŸš¨ğŸš¨
            if (isIdChecked === false) {
                alert("ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.");
                event.preventDefault(); // ì œì¶œ ì¤‘ë‹¨
                return false;
            }
            
            // 2ì°¨ ê²€ì¦: ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
            var pw1 = $("#userPw").val();
            var pw2 = $("#userPw2").val();

            if (pw1 !== pw2) {
                alert("ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                event.preventDefault(); 
                return false;
            }
            
            // ëª¨ë“  ê²€ì¦ í†µê³¼ ì‹œ ì„œë²„ë¡œ ì œì¶œ
            return true;
        });
    });
</script>
</body>
</html>