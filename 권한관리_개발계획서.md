# 권한 관리 기능 개발 계획서

## 1. 개요

### 목적
회원을 Guest와 Admin 권한으로 구분하고, Admin 권한을 가진 사용자만 회원 관리 페이지에 접근하여 권한을 관리할 수 있도록 구현

### 주요 기능
- 회원가입 시 기본 Guest 권한 부여
- Admin 전용 회원 관리 페이지
- 회원 목록 조회 (이름, 아이디, 권한)
- 드롭다운을 통한 권한 변경 (Guest ↔ Admin 양방향)

---

## 2. 데이터베이스 수정

### TB_USER 테이블 변경
```sql
ALTER TABLE TB_USER ADD COLUMN role VARCHAR(20) DEFAULT 'GUEST' NOT NULL;
ALTER TABLE TB_USER ADD COLUMN name VARCHAR(100) NOT NULL;
ALTER TABLE TB_USER MODIFY COLUMN email VARCHAR(255) NOT NULL;
```

**변경 사항:**
- `role` 컬럼 추가
- 기본값: `GUEST`
- 가능한 값: `GUEST`, `ADMIN`
- `name` 컬럼 추가 (회원 이름)
- `email` 컬럼을 NOT NULL로 변경 (필수 입력)

---

## 3. 개발 범위

### 3.1 Entity 수정

#### User.java
```java
// 추가 필드
@Enumerated(EnumType.STRING)
@Column(nullable = false)
private Role role = Role.GUEST;

@Column(nullable = false, length = 100)
private String name;

@Column(nullable = false)
private String email;
```

#### Role.java (신규)
```java
public enum Role {
    GUEST, ADMIN
}
```

---

### 3.2 의존성 추가

#### pom.xml
```xml
<!-- 이메일 검증을 위한 Validation 의존성 (Spring Boot에 기본 포함) -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

---

### 3.3 Repository 수정

#### UserRepository.java
```java
// 추가 메서드
List<User> findAllByOrderByCreateDtDesc();
```

---

### 3.4 Service 계층

#### UserService.java
**수정 사항:**
- 회원가입 시 기본 `Role.GUEST` 설정
- 회원가입 시 이름, 이메일 필수 입력 처리
- 이메일 형식 검증 (`@Email` 어노테이션)
- 회원 목록 조회 메서드 추가
- 권한 변경 메서드 추가

**신규 메서드:**
```java
List<UserListDto> getAllUsers()
void updateUserRole(Long userNo, Role role)
```

---

### 3.5 DTO 추가

#### UserListDto.java (신규)
```java
@Getter
public class UserListDto {
    private Long userNo;
    private String username;
    private String name;
    private String email;
    private Role role;
    private LocalDateTime createDt;
}
```

#### UserSignupDto.java (신규)
```java
@Getter
@Setter
public class UserSignupDto {
    @NotBlank(message = "아이디는 필수입니다")
    private String username;
    
    @NotBlank(message = "비밀번호는 필수입니다")
    private String password;
    
    @NotBlank(message = "이름은 필수입니다")
    private String name;
    
    @NotBlank(message = "이메일은 필수입니다")
    @Email(message = "올바른 이메일 형식이 아닙니다")
    private String email;
}
```

---

### 3.6 Controller 수정 및 추가

#### UserController.java
**수정 사항:**
- 회원가입 폼에 이름, 이메일 입력 필드 추가
- `UserSignupDto` 사용하여 입력값 검증
- `@Valid` 어노테이션으로 이메일 형식 자동 검증

#### AdminController.java (신규)
**엔드포인트:**
- `GET /admin/users` - 회원 관리 페이지
- `POST /admin/users/{userNo}/role` - 권한 변경 (Guest ↔ Admin)

**접근 제한:**
- `@PreAuthorize("hasRole('ADMIN')")` 적용

---

### 3.7 Security 설정 수정

#### SecurityConfig.java
**변경 사항:**
```java
.requestMatchers("/admin/**").hasRole("ADMIN")
.requestMatchers("/board/create", "/board/modify/**", "/board/delete/**").authenticated()
```

#### UserSecurityService.java
**변경 사항:**
- User의 role을 GrantedAuthority로 변환
- `ROLE_` 접두사 추가

---

### 3.8 View 추가 및 수정

#### signup_form.html (수정)
**수정 사항:**
- 이름 입력 필드 추가
- 이메일 입력 필드 추가 (type="email")
- 이메일 형식 검증 메시지 표시

#### admin/user_list.html (신규)
**구성 요소:**
- 회원 목록 테이블 (번호, 아이디, 이름, 이메일, 권한, 가입일)
- 권한 컬럼에 드롭다운(select) 표시
  - 현재 권한이 선택된 상태로 표시
  - 권한 변경 시 자동으로 서버에 전송 (onChange 이벤트)
  - **자기 자신의 권한은 드롭다운 없이 텍스트로만 표시**
- Guest/Admin 선택 가능

---

## 4. 개발 순서

### Phase 1: 데이터 모델 변경
1. Role enum 생성
2. User entity에 role, name 필드 추가 및 email 필수 처리
3. 데이터베이스 마이그레이션 (ALTER TABLE)

### Phase 2: 비즈니스 로직 구현
4. UserRepository 메서드 추가
5. UserService 수정 (회원가입, 목록 조회, 권한 변경)
6. UserListDto, UserSignupDto 생성

### Phase 3: 회원가입 기능 수정
7. UserController 수정 (이름, 이메일 입력 처리)
8. signup_form.html 수정 (이름, 이메일 필드 추가)
9. 이메일 형식 검증 추가 (`@Email` 어노테이션)

### Phase 4: 보안 설정
10. SecurityConfig 수정 (URL 권한 설정)
11. UserSecurityService 수정 (Role 매핑)

### Phase 5: 관리자 기능 구현
12. AdminController 생성
13. admin/user_list.html 템플릿 생성

### Phase 6: 테스트
14. 회원가입 시 이름, 이메일 필수 입력 확인
15. 이메일 형식 검증 확인
16. Guest 권한 부여 확인
17. Admin 사용자의 회원 관리 페이지 접근 확인
18. Guest 사용자의 회원 관리 페이지 접근 차단 확인
19. 권한 변경 기능 동작 확인

---

## 5. API 명세

### 회원 관리 API

| Method | URL | 설명 | 권한 |
|--------|-----|------|------|
| GET | `/admin/users` | 회원 관리 페이지 | ADMIN |
| POST | `/admin/users/{userNo}/role` | 권한 변경 (Guest ↔ Admin) | ADMIN |

#### 권한 변경 요청
```
POST /admin/users/1/role
Content-Type: application/x-www-form-urlencoded

role=ADMIN  (또는 role=GUEST)
```

---

## 6. 화면 설계

### 회원 관리 페이지 (/admin/users)

```
┌────────────────────────────────────────────────────────────────────────┐
│  회원 관리                                                               │
├────────────────────────────────────────────────────────────────────────┤
│  번호 │ 아이디    │ 이름      │ 이메일           │ 권한           │   │
├────────────────────────────────────────────────────────────────────────┤
│  1   │ admin01  │ 홍길동    │ admin@test.com  │ ADMIN (본인)   │   │
│  2   │ user01   │ 김철수    │ user@test.com   │ [GUEST ▼]      │   │
│  3   │ admin02  │ 이영희    │ admin2@test.com │ [ADMIN ▼]      │   │
└────────────────────────────────────────────────────────────────────────┘
```

**UI 요소:**
- 권한 컬럼: `<select>` 드롭다운
  - 옵션: GUEST, ADMIN
  - 현재 권한이 선택된 상태
- **자기 자신의 권한: 드롭다운 없이 텍스트로만 표시 (예: "ADMIN (본인)")**
- 드롭다운 변경 시 즉시 서버로 전송 (JavaScript onChange)
- 변경 완료 시 알림 메시지 표시

---

## 7. 보안 고려사항

### 권한 검증
- URL 레벨: Spring Security의 `hasRole()` 사용
- 메서드 레벨: `@PreAuthorize` 어노테이션 사용
- 자기 자신의 권한은 UI에서 드롭다운 미표시 (변경 불가)

### 권한 변경 제약
- 자기 자신의 권한은 변경할 수 없음 (UI 레벨에서 차단)
- Guest ↔ Admin 양방향 변경 가능
- 최소 1명 이상의 Admin 유지 권장

---

## 8. 테스트 시나리오

### 8.1 회원가입 테스트
1. 회원가입 폼에서 아이디, 비밀번호, 이름, 이메일 입력
2. 이메일 형식이 올바르지 않을 경우 에러 메시지 확인
3. 올바른 형식으로 가입 완료
4. 데이터베이스에서 role이 'GUEST'인지 확인
5. 이름과 이메일이 정상적으로 저장되었는지 확인

### 8.2 권한별 접근 테스트
1. Admin 계정으로 로그인 → `/admin/users` 접근 성공
2. Guest 계정으로 로그인 → `/admin/users` 접근 실패 (403)

### 8.3 권한 변경 테스트
1. Admin으로 로그인
2. Guest 회원 선택 → 드롭다운에서 ADMIN 선택
3. 해당 회원의 role이 'ADMIN'으로 변경 확인
4. Admin 회원 선택 → 드롭다운에서 GUEST 선택
5. 해당 회원의 role이 'GUEST'로 변경 확인
6. 자기 자신의 권한은 드롭다운이 표시되지 않는지 확인

---

## 9. 향후 확장 가능성

### 추가 권한 레벨
- SUPER_ADMIN: 다른 Admin의 권한도 변경 가능
- MODERATOR: 게시글/댓글 관리만 가능

### 권한 관리 기능 확장
- Admin → Guest 권한 강등 기능
- 회원 비활성화/활성화 기능
- 권한 변경 이력 로깅

### 감사 로그
- 누가, 언제, 누구의 권한을 변경했는지 기록
- 별도의 AUDIT 테이블 생성

---

## 10. 예상 소요 시간

| 작업 | 예상 시간 |
|------|----------|
| Entity 및 Enum 수정 | 30분 |
| Repository/Service 구현 | 1시간 |
| Security 설정 | 30분 |
| Controller 구현 | 1시간 |
| View 템플릿 작성 | 1시간 |
| 테스트 및 디버깅 | 1시간 |
| **총 예상 시간** | **5시간** |

---

## 11. 체크리스트

- [ ] Role enum 생성
- [ ] User entity에 role, name 필드 추가
- [ ] User entity의 email을 필수(NOT NULL)로 변경
- [ ] 데이터베이스 스키마 변경
- [ ] UserRepository 메서드 추가
- [ ] UserSignupDto 생성 (이메일 검증 포함)
- [ ] UserListDto 생성 (이름 필드 포함)
- [ ] UserService 수정 (회원가입, 목록, 권한 변경)
- [ ] UserController 수정 (이름, 이메일 입력 처리)
- [ ] signup_form.html 수정 (이름, 이메일 필드 추가)
- [ ] SecurityConfig 수정
- [ ] UserSecurityService 수정
- [ ] AdminController 생성
- [ ] admin/user_list.html 생성 (이름 컬럼 포함)
- [ ] 네비게이션 메뉴에 "회원 관리" 링크 추가 (Admin만 표시)
- [ ] 회원가입 테스트 (이름, 이메일 필수 입력)
- [ ] 이메일 형식 검증 테스트
- [ ] 권한별 접근 제어 테스트
- [ ] 권한 변경 기능 테스트
