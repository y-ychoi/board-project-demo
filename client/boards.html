<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 목록 - Board App</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>게시판</h1>
            <div class="user-info">
                <span id="userInfo"></span>
                <button id="logoutBtn">로그아웃</button>
            </div>
        </header>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <div class="board-actions">
            <button id="createBoardBtn" class="btn-primary">게시글 작성</button>
        </div>
                
        <div class="board-list">
            <table id="boardTable">
                <thead>
                    <tr>
                        <th>번호</th>
                        <th>제목</th>
                        <th>작성자</th>
                        <th>조회수</th>
                        <th>작성일</th>
                    </tr>
                </thead>
                <tbody id="boardTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="pagination">
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/board-service.js"></script>
    <script src="js/user-service.js"></script>
    <script src="js/state.js"></script>
    <script src="js/GlobalErrorHandler.js"></script>
    <script src="js/app.js"></script>
    <script src="js/page-init.js"></script>
    <script>
	    let app;
	    let currentPage = 0;
	    const pageSize = 10;
	
	    document.addEventListener('DOMContentLoaded', () => {
	        const result = PageInitializer.init(true); // 인증 필요
	        if (!result) return;
	
	        app = result.app;
	        const user = result.user;
	
	        // 관리자 메뉴 추가
	        PageInitializer.addAdminMenu(user);
	
	        // 이벤트 리스너 등록 (빠진 부분 복원)
	        document.getElementById('logoutBtn').addEventListener('click', () => app.logout());
	        document.getElementById('createBoardBtn').addEventListener('click', () => {
	            window.location.href = 'board-create.html';
	        });
	
	        // 상태 변경 감지
	        app.stateManager.subscribe((state) => {
                    if (state.boards) {
                        renderBoards(state.boards);
                    }
                });
	
	        // 초기 페이지 로드
	        loadPage(0);
	    });
	
	    // window.load는 실시간 기능만 담당
	    window.addEventListener('load', () => {
	        setupRealTimeFeatures();
	    });
	
	    function setupRealTimeFeatures() {
	        // localStorage 변경 감지
	        window.addEventListener('storage', (e) => {
	            if (e.key === 'boardCreated') {
	                loadPage(0);
	            }
	        });
	
	        // 게시글 작성 완료 감지
	        const checkBoardCreated = () => {
	            const lastCreated = localStorage.getItem('boardCreated');
	            const lastChecked = sessionStorage.getItem('lastChecked') || '0';
	
	            if (lastCreated && lastCreated > lastChecked) {
	                sessionStorage.setItem('lastChecked', lastCreated);
	                loadPage(0);
	            }
	        };
	
	        window.addEventListener('focus', checkBoardCreated);
	        setInterval(checkBoardCreated, 2000);
	    }
	
	    // 페이지 로드
	    async function loadPage(page) {
	        currentPage = page;
	        try {
	            const result = await app.loadBoards(page, pageSize);
	        } catch (error) {
	            GlobalErrorHandler.getInstance().reportError(error, '게시글 목록 로딩')
	        }
	    }
	
	    // 게시글 목록 렌더링
	    function renderBoards(response) {
	        const tbody = document.getElementById('boardTableBody');
	        tbody.innerHTML = '';
	
	        const boardsData = response.data || response;
	
	        if (boardsData.content && boardsData.content.length > 0) {
	            boardsData.content.forEach(board => {
	                const row = document.createElement('tr');
	                row.innerHTML = `
	                    <td>${board.boardNo}</td>
	                    <td><a href="board-detail.html?id=${board.boardNo}">${board.title}</a></td>
	                    <td>${board.authorName}</td>
	                    <td>${board.viewCnt}</td>
	                    <td>${formatDate(board.createDt)}</td>
	                `;
	                tbody.appendChild(row);
	            });
	
	            // 페이지네이션 렌더링
	            renderPagination(boardsData);
	        } else {
	            tbody.innerHTML = '<tr><td colspan="5">게시글이 없습니다.</td></tr>';
	        }
	    }
	
	    // 페이지네이션 렌더링
	    function renderPagination(pageInfo) {
	        const pagination = document.getElementById('pagination');
	        pagination.innerHTML = '';
	
	        if (pageInfo.totalPages <= 1) return;
	
	        // 이전 버튼
	        if (pageInfo.number > 0) {
	            const prevBtn = document.createElement('button');
	            prevBtn.textContent = '이전';
	            prevBtn.addEventListener('click', () => loadPage(currentPage - 1));
	            pagination.appendChild(prevBtn);
	        }
	
	        // 페이지 번호들
	        const startPage = Math.max(0, pageInfo.number - 2);
	        const endPage = Math.min(pageInfo.totalPages - 1, pageInfo.number + 2);
	
	        for (let i = startPage; i <= endPage; i++) {
	            const button = document.createElement('button');
	            button.textContent = i + 1;
	            if (i === pageInfo.number) {
	                button.classList.add('active');
	            }
	            button.addEventListener('click', () => loadPage(i));
	            pagination.appendChild(button);
	        }
	
	        // 다음 버튼
	        if (pageInfo.number < pageInfo.totalPages - 1) {
	            const nextBtn = document.createElement('button');
	            nextBtn.textContent = '다음';
	            nextBtn.addEventListener('click', () => loadPage(currentPage + 1));
	            pagination.appendChild(nextBtn);
	        }
	    }
	
	    // 날짜 포맷팅
	    function formatDate(dateString) {
	        const date = new Date(dateString);
	        return date.toLocaleDateString('ko-KR');
	    }
	
	    // 페이지가 다시 보여질 때도 새로고침
	    window.addEventListener('pageshow', (event) => {
	        if (event.persisted) {
	            loadPage(currentPage);
	        }
	    });
	</script>
</body>
</html>
