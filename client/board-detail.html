<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세 - Board App</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>게시글 상세</h1>
            <div class="user-info">
                <span id="userInfo"></span>
                <button id="logoutBtn">로그아웃</button>
            </div>
        </header>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">로딩 중...</div>
        
        <div class="board-detail" id="boardDetail" style="display: none;">
            <div class="board-header">
                <h2 id="boardTitle"></h2>
                <div class="board-meta">
                    <span id="boardAuthor"></span>
                    <span id="boardDate"></span>
                    <span id="boardViews"></span>
                </div>
            </div>
            
            <div class="board-content" id="boardContent">
            </div>
            
            <div class="board-actions" id="boardActions">
                <button id="editBtn" class="btn-primary" style="display: none;">수정</button>
                <button id="deleteBtn" class="btn-danger" style="display: none;">삭제</button>
                <button id="backBtn" class="btn-secondary">목록</button>
            </div>
        </div>
        
        <div class="comments-section" id="commentsSection" style="display: none;">
            <h3>댓글</h3>
            
            <div class="comment-form">
                <textarea id="commentContent" placeholder="댓글을 입력하세요..." rows="3"></textarea>
                <button id="addCommentBtn" class="btn-primary">댓글 작성</button>
            </div>
            
            <div class="comments-list" id="commentsList">
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/board-service.js"></script>
    <script src="js/user-service.js"></script>
    <script src="js/state.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/app.js"></script>
    <script>
        const app = new BoardApp();
        const urlParams = new URLSearchParams(window.location.search);
        const boardNo = urlParams.get('id');
        
        if (!boardNo) {
            window.location.href = 'boards.html';
        }
        
        // 인증 확인
        if (!app.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // 사용자 정보 표시
        const user = app.getUser();
        document.getElementById('userInfo').textContent = `${user.name}님 (${user.role})`;
        
        // 로그아웃 버튼
        document.getElementById('logoutBtn').addEventListener('click', () => {
            app.logout();
        });
        
        // 목록 버튼
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = 'boards.html';
        });
        
        // 상태 변경 리스너
        app.stateManager.subscribe((state) => {
            document.getElementById('loading').style.display = state.loading ? 'block' : 'none';
            
            if (state.currentBoard) {
                renderBoard(state.currentBoard);
            }
        });
        
        // 게시글 렌더링
        function renderBoard(board) {
            document.getElementById('boardTitle').textContent = board.title;
            document.getElementById('boardAuthor').textContent = `작성자: ${board.authorName || '알 수 없음'}`;
            document.getElementById('boardDate').textContent = `작성일: ${new Date(board.createDt).toLocaleString()}`;
            document.getElementById('boardViews').textContent = `조회수: ${board.viewCnt}`;
            document.getElementById('boardContent').innerHTML = board.content.replace(/\n/g, '<br>');
            
            // 작성자인 경우만 수정 버튼 표시, 삭제는 작성자 또는 관리자
			if (board.authorNo === user.userNo) {
    			document.getElementById('editBtn').style.display = 'inline-block';
			}

			if (board.authorNo === user.userNo || user.role === 'ADMIN') {
    			document.getElementById('deleteBtn').style.display = 'inline-block';
			}
            
            document.getElementById('boardDetail').style.display = 'block';
            document.getElementById('commentsSection').style.display = 'block';
            
            loadComments();
        }
        
        // 댓글 로드
        async function loadComments() {
            try {
                const comments = await app.boardService.getComments(boardNo);
                renderComments(comments);
            } catch (error) {
                app.errorHandler.handleError(error);
            }
        }
        
        // 댓글 목록 렌더링
		function renderComments(comments) {
    		const commentsDiv = document.getElementById('comments');
		    commentsDiv.innerHTML = '';

		    comments.forEach(comment => {
        		const commentDiv = document.createElement('div');
		        commentDiv.className = 'comment';

        // 수정 여부 확인 (생성일시와 수정일시 비교)
		        const isModified = new Date(comment.createDt).getTime() !== new Date(comment.modifyDt).getTime();
        	const modifiedTag = isModified ? ' <span class="modified-tag">(수정됨)</span>' : '';

		        commentDiv.innerHTML = `
		      	    <div class="comment-header">
		                <span class="comment-author">${comment.authorName}</span>
		                <span class="comment-date">${new Date(comment.createDt).toLocaleString()}${modifiedTag}</span>
            		</div>
		            <div class="comment-content" id="comment-content-${comment.commentNo}">
		                ${comment.content}
        		    </div>
            		<div class="comment-edit-form" id="comment-edit-${comment.commentNo}" style="display: none;">
                		<textarea id="edit-content-${comment.commentNo}">${comment.content}</textarea>
		                <button onclick="saveComment(${comment.commentNo})">저장</button>
		                <button onclick="cancelEdit(${comment.commentNo})">취소</button>
        		    </div>
            		<div class="comment-actions">
		                ${comment.authorNo === user.userNo ?
        		            `<button class="comment-edit" onclick="editComment(${comment.commentNo})">수정</button>
                		     <button class="comment-delete" onclick="deleteComment(${comment.commentNo})">삭제</button>` : ''}
            		</div>
        		`;
        		commentsDiv.appendChild(commentDiv);
    		});
		}
        
        // 댓글 작성
        document.getElementById('addCommentBtn').addEventListener('click', async () => {
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                alert('댓글 내용을 입력하세요.');
                return;
            }
            
            try {
                await app.boardService.createComment(boardNo, content);
                document.getElementById('commentContent').value = '';
                loadComments();
            } catch (error) {
                app.errorHandler.handleError(error);
            }
        });
        
        // 댓글 삭제
        async function deleteComment(commentNo) {
            if (!confirm('댓글을 삭제하시겠습니까?')) return;
            
            try {
                await app.boardService.deleteComment(boardNo, commentNo);
                loadComments();
            } catch (error) {
                app.errorHandler.handleError(error);
            }
        }
        
        // 게시글 수정 버튼
		document.getElementById('editBtn').addEventListener('click', () => {
    		window.location.href = `board-edit.html?id=${boardNo}`;
		});
        
        // 게시글 삭제
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm('게시글을 삭제하시겠습니까?')) return;
            
            try {
                await app.deleteBoard(boardNo);
                alert('게시글이 삭제되었습니다.');
                window.location.href = 'boards.html';
            } catch (error) {
                app.errorHandler.handleError(error);
            }
        });
        
        // 초기 로드
        app.loadBoard(boardNo);
    </script>
</body>
</html>
