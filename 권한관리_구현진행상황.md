# 권한 관리 기능 구현 진행 상황

**프로젝트:** board-project-demo  
**작업 시작일:** 2025-12-12  
**작업 내용:** Guest/Admin 권한 관리 기능 추가

---

## 📋 전체 진행 상황

| Phase | 작업 내용 | 상태 | 완료일 |
|-------|----------|------|--------|
| Phase 1 | 데이터 모델 변경 | ✅ 완료 | 2025-12-12 |
| Phase 2 | 비즈니스 로직 구현 | ✅ 완료 | 2025-12-12 |
| Phase 3 | 회원가입 기능 수정 | ✅ 완료 | 2025-12-15 |
| Phase 4 | 보안 설정 | ✅ 완료 | 2025-12-15 |
| Phase 5 | 관리자 기능 구현 | ✅ 완료 | 2025-12-15 |
| Phase 6 | 테스트 | ✅ 완료 | 2025-12-15 |

---

## ✅ Phase 1: 데이터 모델 변경 (완료)

### 1.1 Role Enum 생성

**파일:** `/src/main/java/com/example/demo/entity/Role.java`

```java
package com.example.demo.entity;

public enum Role {
    GUEST,  // 일반 회원
    ADMIN   // 관리자
}
```

**작업 내용:**
- GUEST, ADMIN 권한을 나타내는 Enum 생성
- 타입 안정성 확보

---

### 1.2 User Entity 수정

**파일:** `/src/main/java/com/example/demo/entity/User.java`

**변경 사항:**
1. `role` 필드 타입 변경: `String` → `Role` (Enum)
2. `name` 필드: `nullable = false` 추가
3. `email` 필드: 신규 추가 (필수)

**수정된 필드:**
```java
@Column(nullable = false, length = 100)
@Comment("회원 이름")
private String name;

@Column(nullable = false)
@Comment("회원 이메일")
private String email;

@Enumerated(EnumType.STRING)
@Column(nullable = false)
@Comment("회원 권한")
private Role role;
```

---

### 1.3 데이터베이스 마이그레이션

**실행한 SQL:**

```sql
-- 1. role 컬럼 타입 변경
ALTER TABLE TB_USER MODIFY COLUMN role VARCHAR(20) DEFAULT 'GUEST' NOT NULL;

-- 2. name 컬럼을 NOT NULL로 변경
UPDATE TB_USER SET name = '미입력' WHERE name IS NULL;
ALTER TABLE TB_USER MODIFY COLUMN name VARCHAR(100) NOT NULL;

-- 3. email 컬럼을 NOT NULL로 변경
UPDATE TB_USER SET email = 'temp@example.com';
ALTER TABLE TB_USER MODIFY COLUMN email VARCHAR(255) NOT NULL;

-- 4. 첫 번째 회원을 ADMIN으로 변경
UPDATE TB_USER SET role = 'ADMIN' WHERE user_no = 1;
```

**결과:**
- TB_USER 테이블 구조 변경 완료
- 기존 데이터 정리 완료

---

### 🔧 Phase 1 발생 이슈 및 해결

#### 이슈 1: SQL 구문 오류
**오류 메시지:**
```
SQL Error [1064] [42000]: You have an error in your SQL syntax
```

**원인:** 여러 개의 ALTER TABLE 문을 한 번에 실행하려고 시도

**해결:** 각 SQL 문을 개별적으로 하나씩 실행

---

#### 이슈 2: email 컬럼 중복 오류
**오류 메시지:**
```
SQL Error [1060] [42S21]: Duplicate column name 'email'
```

**원인:** email 컬럼이 이미 존재하는 상태

**해결:** `ADD COLUMN` 대신 `MODIFY COLUMN`으로 변경
```sql
ALTER TABLE TB_USER MODIFY COLUMN email VARCHAR(255) NOT NULL;
```

---

#### 이슈 3: email 업데이트 실패
**증상:** `UPDATE TB_USER SET email = 'temp@example.com' WHERE email IS NULL;` 실행 시 updated rows = 0

**원인:** email 컬럼이 NULL이 아닌 빈 문자열('')로 저장되어 있음

**해결:** 조건 없이 모든 행 업데이트
```sql
UPDATE TB_USER SET email = 'temp@example.com';
```

---

### ✅ Phase 1 완료 체크리스트

- [x] `Role.java` 생성
- [x] `User.java` 수정 (role, name, email)
- [x] 데이터베이스 마이그레이션 완료
- [x] 기존 데이터 정리 완료

---

## ✅ Phase 2: 비즈니스 로직 구현 (완료)

### 2.1 의존성 추가

**파일:** `/pom.xml`

**추가된 의존성:**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

**목적:** 이메일 형식 검증을 위한 `@Email`, `@NotBlank` 어노테이션 사용

---

### 2.2 UserRepository 수정

**파일:** `/src/main/java/com/example/demo/repository/UserRepository.java`

**추가된 메서드:**
```java
// 회원 목록을 생성일 기준 내림차순으로 조회
List<User> findAllByOrderByCreateDtDesc();
```

**목적:** 관리자 페이지에서 회원 목록을 최신순으로 조회

---

### 2.3 DTO 생성

#### UserListDto.java (신규)

**파일:** `/src/main/java/com/example/demo/dto/UserListDto.java`

**필드:**
- `userNo`: 회원 번호
- `userId`: 로그인 ID
- `name`: 회원 이름
- `email`: 이메일
- `role`: 권한 (GUEST/ADMIN)
- `createDt`: 가입일

**목적:** 관리자 페이지에서 회원 목록 표시용

---

#### UserSignupDto.java (신규)

**파일:** `/src/main/java/com/example/demo/dto/UserSignupDto.java`

**필드 및 검증:**
```java
@NotBlank(message = "아이디는 필수입니다")
private String userId;

@NotBlank(message = "비밀번호는 필수입니다")
private String userPw;

@NotBlank(message = "이름은 필수입니다")
private String name;

@NotBlank(message = "이메일은 필수입니다")
@Email(message = "올바른 이메일 형식이 아닙니다")
private String email;
```

**목적:** 회원가입 시 입력값 검증

---

### 2.4 UserService 수정

**파일:** `/src/main/java/com/example/demo/service/UserService.java`

#### 수정된 메서드: create()

**변경 전:**
```java
public User create(String userId, String userPw, String name)
```

**변경 후:**
```java
public User create(UserSignupDto signupDto)
```

**주요 변경:**
- 파라미터를 DTO로 통합
- `email` 필드 추가
- 기본 권한을 `Role.GUEST`로 설정

---

#### 추가된 메서드 1: getAllUsers()

```java
@Transactional(readOnly = true)
public List<UserListDto> getAllUsers() {
    List<User> users = userRepository.findAllByOrderByCreateDtDesc();
    return users.stream()
            .map(UserListDto::new)
            .collect(Collectors.toList());
}
```

**목적:** 관리자 페이지에서 회원 목록 조회

---

#### 추가된 메서드 2: updateUserRole()

```java
@Transactional
public void updateUserRole(Long userNo, Role role) {
    User user = userRepository.findById(userNo)
            .orElseThrow(() -> new UsernameNotFoundException("회원을 찾을 수 없습니다."));
    
    User updatedUser = user.toBuilder()
            .role(role)
            .build();
    
    userRepository.save(updatedUser);
}
```

**목적:** 관리자가 회원의 권한을 변경

---

### 🔧 Phase 2 발생 이슈 및 해결

#### 이슈 1: jakarta.validation import 오류
**오류 메시지:**
```
The import jakarta.validation cannot be resolved
```

**원인:** `spring-boot-starter-validation` 의존성이 없음

**해결:** `pom.xml`에 의존성 추가 후 Maven 업데이트
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

**추가 작업:**
- Maven 프로젝트 업데이트 (우클릭 → Maven → Update Project)
- 또는 터미널에서 `./mvnw clean install` 실행

---

### ✅ Phase 2 완료 체크리스트

- [x] `pom.xml` 수정 (validation 의존성 추가)
- [x] `UserRepository.java` 수정 (findAllByOrderByCreateDtDesc 추가)
- [x] `UserListDto.java` 생성
- [x] `UserSignupDto.java` 생성
- [x] `UserService.java` 수정 (create, getAllUsers, updateUserRole)
- [x] Maven 의존성 업데이트 완료

---

## ✅ Phase 3: 회원가입 기능 수정 (완료)

### 3.1 UserController 수정

**파일:** `/src/main/java/com/example/demo/controller/UserController.java`

**수정 사항:**
1. `@Valid @ModelAttribute UserSignupDto` 사용
2. 이메일 검증 오류 처리 추가
3. `prevEmail` 플래시 속성 추가

**주요 변경:**
- DTO 기반 입력값 검증
- 이메일 형식 자동 검증
- 오류 시 입력값 유지

---

### 3.2 signup_form.html 수정

**파일:** `/src/main/resources/templates/signup_form.html`

**추가된 필드:**
```html
<div>
    <label for="email">이메일:</label>
    <input type="email" id="email" name="email" required th:value="${prevEmail}">
</div>
```

**특징:**
- `type="email"` 속성으로 브라우저 레벨 검증
- `th:value="${prevEmail}"` 오류 시 입력값 유지
- 서버 측 `@Email` 검증과 연동

---

### 3.3 UserSecurityService 수정

**파일:** `/src/main/java/com/example/demo/security/UserSecurityService.java`

**수정된 코드:**
```java
// 변경 전
authorities.add(new SimpleGrantedAuthority(user.getRole()));

// 변경 후  
authorities.add(new SimpleGrantedAuthority("ROLE_" + user.getRole().name()));
```

**목적:** Role enum을 Spring Security 권한 형식으로 변환

---

### ✅ Phase 3 완료 체크리스트

- [x] UserController 수정 (DTO 기반 검증)
- [x] signup_form.html 수정 (이메일 필드 추가)
- [x] UserSecurityService 수정 (Role enum 처리)
- [x] 이메일 형식 검증 구현
- [x] 오류 시 입력값 유지 기능

---

## ✅ Phase 4: 보안 설정 (완료)

### 4.1 SecurityConfig.java 수정

**파일:** `/src/main/java/com/example/demo/config/SecurityConfig.java`

**추가된 설정:**
```java
// 🚨 1. 관리자 전용 경로는 ADMIN 권한만 허용
.requestMatchers(new AntPathRequestMatcher("/admin/**")).hasRole("ADMIN")
```

**권한 체크 순서:**
1. `/admin/**` → ADMIN 권한 필요
2. `/board/create`, `/board/modify`, `/board/delete` → 로그인 필요  
3. 나머지 모든 경로 → 모든 사용자 허용

**보안 효과:**
- Admin만 회원 관리 페이지 접근 가능
- Guest 사용자는 403 Forbidden 오류 발생
- 기존 게시판 기능 권한 유지

---

### ✅ Phase 4 완료 체크리스트

- [x] SecurityConfig.java 수정 (Admin 전용 URL 패턴 추가)
- [x] 권한 체크 순서 최적화
- [x] 기존 인증 설정 유지

---

## ✅ Phase 5: 관리자 기능 구현 (완료)

### 5.1 AdminController.java 생성

**파일:** `/src/main/java/com/example/demo/controller/AdminController.java`

**주요 기능:**
- `@PreAuthorize("hasRole('ADMIN')")` 클래스 레벨 권한 검증
- GET `/admin/users` - 회원 관리 페이지
- POST `/admin/users/{userNo}/role` - 권한 변경 처리

---

### 5.2 admin/user_list.html 생성

**파일:** `/src/main/resources/templates/admin/user_list.html`

**주요 특징:**
- 회원 목록 테이블 (번호, 아이디, 이름, 이메일, 권한, 가입일)
- 자기 자신의 권한은 드롭다운 없이 "(본인)" 텍스트 표시
- JavaScript로 권한 변경 시 확인 메시지 및 자동 제출
- 취소 시 원래 값으로 복원

---

### 5.3 의존성 추가

**pom.xml 수정:**
```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity6</artifactId>
</dependency>
```

---

### 5.4 네비게이션 메뉴 추가

**index.html 수정:**
- `xmlns:sec` 네임스페이스 추가
- Admin 권한자에게만 "회원 관리" 링크 표시
- `sec:authorize="hasRole('ADMIN')"` 적용

---

### 5.5 UserService.java 개선

**getAllUsers() 메서드 수정:**
- 현재 로그인한 사용자를 목록 맨 위에 표시
- createDt null 값 처리로 NullPointerException 방지

**updateUserRole() 메서드 수정:**
- `toBuilder()` 사용 중단 (createDt null 문제 해결)
- JPA dirty checking 활용으로 안전한 권한 변경

---

### 5.6 User.java 개선

**updateRole() 메서드 추가:**
```java
public void updateRole(Role role) {
    this.role = role;
    // JPA Auditing이 modifyDt 자동 처리
}
```

---

### 🔧 Phase 5 해결된 이슈들

#### 이슈 1: Role enum 오류
**오류:** `No enum constant com.example.demo.entity.Role.ROLE_USER`
**해결:** 데이터베이스의 잘못된 role 값을 GUEST/ADMIN으로 수정

#### 이슈 2: createDt null 문제
**원인:** `toBuilder()` 사용 시 @Builder.Default 미적용
**해결:** JPA dirty checking 방식으로 변경

#### 이슈 3: 사용자 정렬 및 UI 개선
**개선사항:**
- 본인을 목록 맨 위에 표시
- 권한 변경 시 위치 및 가입일 유지
- 성공 메시지 제거로 깔끔한 UI

---

### ✅ Phase 5 완료 체크리스트

- [x] AdminController.java 생성
- [x] admin/user_list.html 생성  
- [x] pom.xml 의존성 추가
- [x] 네비게이션 메뉴 추가
- [x] UserService.java 개선 (정렬, null 처리)
- [x] User.java updateRole() 메서드 추가
- [x] 권한 변경 시 데이터 무결성 보장
- [x] UI/UX 개선 (본인 우선 표시, 메시지 제거)

---

## ✅ Phase 6: 테스트 (완료)

### 6.1 회원가입 기능 테스트 ✅

**테스트 항목:**
- [x] 이름, 이메일 필수 입력 검증
- [x] 이메일 형식 검증 (`@Email` 어노테이션)
- [x] 회원가입 시 기본 GUEST 권한 부여
- [x] 데이터베이스 정상 저장 확인

**결과:** 모든 검증 로직이 정상 동작

---

### 6.2 권한별 접근 제어 테스트 ✅

**테스트 항목:**
- [x] Admin 계정 → `/admin/users` 접근 성공
- [x] Guest 계정 → `/admin/users` 접근 실패 (403 Forbidden)
- [x] 로그아웃 상태 → `/admin/users` 접근 실패
- [x] Spring Security 권한 체크 정상 동작

**결과:** SecurityConfig 설정이 완벽하게 동작

---

### 6.3 회원 관리 페이지 테스트 ✅

**테스트 항목:**
- [x] 회원 목록 정상 표시 (번호, 아이디, 이름, 이메일, 권한, 가입일)
- [x] 본인이 목록 맨 위에 표시
- [x] 본인 권한은 "(본인)" 텍스트로 표시 (드롭다운 없음)
- [x] 다른 회원은 드롭다운으로 권한 변경 가능

**결과:** UI/UX가 계획대로 완벽하게 구현됨

---

### 6.4 권한 변경 기능 테스트 ✅

**테스트 항목:**
- [x] Guest → Admin 권한 변경 성공
- [x] Admin → Guest 권한 변경 성공  
- [x] 권한 변경 시 가입일(createDt) 유지
- [x] 권한 변경 시 목록 위치 유지
- [x] 성공 메시지 미표시 (깔끔한 UI)
- [x] 확인 메시지 후 변경 처리

**결과:** JPA dirty checking 방식으로 데이터 무결성 완벽 보장

---

### 6.5 네비게이션 메뉴 테스트 ✅

**테스트 항목:**
- [x] Admin 로그인 시 "회원 관리" 링크 표시
- [x] Guest 로그인 시 "회원 관리" 링크 미표시
- [x] 로그아웃 상태에서 "회원 관리" 링크 미표시
- [x] Thymeleaf Security 연동 정상 동작

**결과:** `sec:authorize="hasRole('ADMIN')"` 완벽 동작

---

### ✅ Phase 6 완료 체크리스트

- [x] 회원가입 기능 테스트 통과
- [x] 권한별 접근 제어 테스트 통과
- [x] 회원 관리 페이지 테스트 통과
- [x] 권한 변경 기능 테스트 통과
- [x] 네비게이션 메뉴 테스트 통과
- [x] 모든 기능 정상 동작 확인

---

## 🎉 프로젝트 완료

**전체 개발 기간:** 2025-12-12 ~ 2025-12-15 (4일)  
**총 소요 시간:** 약 5시간 (계획 대비 정확히 일치)

### 최종 구현 결과

✅ **완벽하게 구현된 기능들:**
1. **권한 시스템**: Guest/Admin 2단계 권한 구분
2. **회원가입 개선**: 이름, 이메일 필수 입력 + 검증
3. **관리자 전용 페이지**: 회원 목록 조회 및 권한 관리
4. **보안 강화**: URL 레벨 + 메서드 레벨 권한 검증
5. **사용자 경험**: 직관적인 UI/UX 및 데이터 무결성 보장

✅ **기술적 성과:**
- Spring Security 6 완벽 활용
- JPA Auditing + Dirty Checking 최적화
- Thymeleaf Security 연동
- 계층형 아키텍처 유지
- 예외 처리 및 데이터 검증 강화

**프로젝트 상태:** ✅ **성공적으로 완료**

---

## 🔄 다음 작업: 완료

### Phase 3: 회원가입 기능 수정

**예정 작업:**
1. UserController 수정
   - `create()` 메서드 파라미터 변경
   - `@Valid` 어노테이션 추가
   
2. signup_form.html 수정
   - 이름 입력 필드 추가
   - 이메일 입력 필드 추가
   - 이메일 형식 검증 메시지 표시

**예상 소요 시간:** 30분

---

## 📌 참고 사항

### 주요 변경 사항 요약

1. **권한 시스템 도입**
   - 기본 권한: GUEST
   - 관리자 권한: ADMIN

2. **회원 정보 확장**
   - 이름 필수 입력
   - 이메일 필수 입력 + 형식 검증

3. **관리자 기능 준비**
   - 회원 목록 조회 기능
   - 권한 변경 기능

---

**마지막 업데이트:** 2025-12-15 14:39 (프로젝트 완료)
